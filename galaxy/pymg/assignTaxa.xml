<tool id="Assign_Taxa" name="AssignTaxa" version="0.2.2">
  <description>Assign a taxon to each read in a hit table. </description>
  <command>
      assignTaxaToReadsFromBlast.py -i $input1 -o $out_file1 -q 
      -f $m8format
#if $source.blastdb == "RefSeq":
        -p accs
        -m "${source.source_select.fields.taxmapfile}"
        -n "${source.source_select.fields.taxdump}"
#end if
#if $source.blastdb == "Silva":
        -p hitid
        -m "${source.mappingFile.fields.path}"
        -n "${source.mappingFile.fields.taxdump}"
#end if
        -c $cutoff
        -C $method
        $rank
        $taxid
#if $filter.usefilter:
        -F $filter.filterPct
#end if


  </command>
  <inputs>
    <param format="tabular" name="input1" type="data" label="In data table" help="Data missing? See TIP below"/>
     <param name="m8format" type="select" label="Hit table format">
            <option value="last">Lastal tabular</option>
            <option value="blast">Blast-like </option>
            <option value="gene" selected="True">Gene: Blast-like plus read and hit description columns</option> 
            <option value="liz">Liz: Blast-like plus hit description column</option>
            <option value="sam">SAM</option>
     </param>
    <conditional name="source">
	    <param name="blastdb" type="select" label="Which blast database was used?">
              <option value="RefSeq">RefSeq</option>	    
              <option value="Silva">Silva</option>	    
	    </param>
        <when value="RefSeq">
	     <param name="source_select" type="select" display="radio" label="against target database">
            <options from_file="lastdb_p.loc" >
				<column name="value" index="0"/>
				<column name="name" index="1"/>

				<column name="taxmapfile" index="3"/>
			   <column name="taxdump" index="6"/>
			   <filter type="static_value" value="None" column="6"
				   keep="False"/>
			</options>
         </param>
        </when>
        <when value="Silva">
          <param name="mappingFile" type="select" display="radio" label="Map Silva IDs to">
           <options from_file="silva_mapping_tables.loc" >
			   <column name="value" index="0"/>
			   <column name="name" index="1"/>
			   <column name="path" index="2"/>
			   <column name="taxdump" index="3"/>
			   <filter type="static_value" value="None" column="3" keep="false"/>
		   </options>
          </param>
        </when>
    </conditional>
    <param name="cutoff" type="float" size="10" value="0.01" label="Hide counts below this fraction of total:"/>
         <param name="rank" type="select" label="Rank to collect counts on:">
            <option value=" " selected="True">None</option>
            <option value="-r domain">domain</option>
            <option value="-r phylum">phylum</option>
            <option value="-r class">class</option>
            <option value="-r order">order</option>
            <option value="-r family">family</option>
            <option value="-r genus">genus</option>
            <option value="-r species">species</option>
         </param>
         <param name="taxid" type="select" label="Output NCBI txids instead of names">
            <option value=" ">False</option>
            <option value="-T">True</option>
         </param>
	     <param name="method" type="select" label="How to deal with multiple hits per read:">
              <option value="first">Take first hit</option>	    
              <option value="all">Keep all hits</option>	    
              <option value="consensus">Consensus: None unless all hits are to same org</option>	    
              <option value="most">Take most common hit</option>	    
              <option value="LCA">Use least common ancestor of all hits</option>
	     </param>
    <conditional name="filter">
        <param name="usefilter" type="boolean" checked="True" truevalue="True" falsevalue="False" label="Filter input table on hit quality"/>
        <when value="True">
             <param name="filterPct" type="integer" size="10" value="10" label="Keep only hits within this percentage of the best hit for each read. 0-> only the top score for each read."/>
        </when>
    </conditional>
 
  </inputs>
  <outputs>
    <data format="tabular" name="out_file1" metadata_source="input1"/>
  </outputs>
  <help>

 .. class:: infomark

**TIP:** If your data is not TAB delimited, use *Text Manipulation-&gt;Convert* or *Blast-&gt;Parse blast text*

-----

**What it does**

This tool takes a (b)last hit table (against Silva or RefSeq) and assigns a taxon to each read based on what it hit.

-----

**What it ACTUALLY does**

This tool runs the script assignTaxaToReadsFromBlast.py (http://pyrodata.mit.edu/ddr2/scripts/show/63)

</help>
</tool>
